# Redirect www â†’ root
www.daifend.ai {
    redir https://daifend.ai{uri} 308
}

# Main site
daifend.ai {
    encode zstd gzip

    # --- allow ACME challenges ---
    @wellknown path /.well-known/*

    # --- match any dotfile path (e.g., /.git, /.env, /.foo) ---
    @dotfiles path_regexp dotfiles (^|/)\.

    # --- negate /.well-known/* so we don't block LE challenges ---
    @not_wellknown not path /.well-known/*

    # --- explicitly match .env and variants anywhere in path ---
    @envfiles path_regexp envfiles (?i)/\.?env(\.|$)

    # Block dotfiles except ACME paths
    respond @dotfiles @not_wellknown 404

    # Block any .env access
    respond @envfiles 404

    # App reverse proxy
    reverse_proxy app:5000

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer-when-downgrade"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Cache-Control "public, max-age=3600"
    }

    log {
        output stdout
        format console
    }
}
