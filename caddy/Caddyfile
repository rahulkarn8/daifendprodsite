{
    # Uses production ACME endpoint from compose env (or defaults to prod if unset)
    acme_ca {env.CADDY_ACME_CA}
    email   {env.CADDY_ADMIN_EMAIL}
    # debug  # uncomment temporarily for verbose logs
}

# Redirect www â†’ apex
www.daifend.ai {
    redir https://daifend.ai{uri} 308
}

# Primary site
daifend.ai {
    encode zstd gzip

    # --- Security hardening ---
    @wellknown path /.well-known/*                 # keep ACME path open
    @dotfiles path_regexp dotfiles (^|/)\.         # any leading dotfile
    @not_wellknown not path /.well-known/*         # not /.well-known/*
    @envfiles path_regexp envfiles (?i)/\.?env(\.|$)
    respond @dotfiles @not_wellknown 404           # deny dotfiles except ACME
    respond @envfiles 404                          # deny .env variants

    # App upstream (compose service name + port)
    reverse_proxy app:5000

    # Secure headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "no-referrer-when-downgrade"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Cache-Control "public, max-age=3600"
    }

    log {
        output stdout
        format console
    }
}
